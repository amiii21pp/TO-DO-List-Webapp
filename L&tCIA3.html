<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultimate To-Do List</title>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body.dark-mode { background:#121212; color:#fff; }
    .completed { text-decoration: line-through; opacity:0.6; }
    .task-card { transition: transform 0.2s; }
    .task-card:hover { transform: scale(1.02); }
    #progressBar { height:20px; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="text-center mb-4">🚀 Ultimate To-Do List</h1>

    <!-- Controls -->
    <div class="mb-3 d-flex flex-wrap">
      <input id="taskInput" class="form-control mr-2 mb-2" placeholder="Add task...">
      <input id="deadlineInput" type="date" class="form-control mr-2 mb-2">
      <select id="priorityInput" class="form-control mr-2 mb-2">
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
      </select>
      <button id="addTaskBtn" class="btn btn-primary mb-2">Add</button>
    </div>

    <!-- Search & Sort -->
    <div class="d-flex mb-3">
      <input id="searchInput" class="form-control mr-2" placeholder="Search tasks...">
      <select id="sortSelect" class="form-control">
        <option value="created">Sort by Created</option>
        <option value="deadline">Sort by Deadline</option>
        <option value="priority">Sort by Priority</option>
      </select>
    </div>

    <!-- Progress -->
    <div class="mb-3">
      <div class="progress">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
      </div>
      <small id="progressText"></small>
    </div>

    <!-- Actions -->
    <div class="mb-3">
      <button id="toggleMode" class="btn btn-secondary">🌙 Toggle Dark Mode</button>
      <button id="exportBtn" class="btn btn-info">📤 Export</button>
      <input type="file" id="importFile" hidden>
      <button id="importBtn" class="btn btn-info">📥 Import</button>
      <button id="voiceBtn" class="btn btn-warning">🎤 Voice Input</button>
    </div>

    <!-- Gamification -->
    <div class="mb-3">
      <h5>🔥 Streak: <span id="streak">0</span> days | ⭐ XP: <span id="xp">0</span></h5>
    </div>

    <!-- Task List -->
    <ul id="taskList" class="list-group"></ul>
  </div>

  <!-- Bootstrap + JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
  <script>
    let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
    let xp = parseInt(localStorage.getItem("xp")) || 0;
    let streak = parseInt(localStorage.getItem("streak")) || 0;

    const taskInput = document.getElementById("taskInput");
    const deadlineInput = document.getElementById("deadlineInput");
    const priorityInput = document.getElementById("priorityInput");
    const taskList = document.getElementById("taskList");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    document.getElementById("xp").innerText = xp;
    document.getElementById("streak").innerText = streak;

    // Add Task
    document.getElementById("addTaskBtn").onclick = () => {
      if (!taskInput.value) return;
      tasks.push({
        text: taskInput.value,
        deadline: deadlineInput.value || null,
        priority: priorityInput.value,
        completed: false,
        created: Date.now(),
        subtasks: []
      });
      taskInput.value = "";
      deadlineInput.value = "";
      saveTasks();
      renderTasks();
    };

    // Save
    function saveTasks(){
      localStorage.setItem("tasks", JSON.stringify(tasks));
      localStorage.setItem("xp", xp);
      localStorage.setItem("streak", streak);
    }

    // Render
    function renderTasks(search=""){
      taskList.innerHTML = "";
      let filtered = tasks.filter(t => t.text.toLowerCase().includes(search));
      let sortBy = document.getElementById("sortSelect").value;
      if (sortBy=="deadline") filtered.sort((a,b)=> new Date(a.deadline||999999999999)-new Date(b.deadline||999999999999));
      if (sortBy=="priority") filtered.sort((a,b)=> (a.priority>b.priority)?-1:1);
      if (sortBy=="created") filtered.sort((a,b)=> a.created-b.created);

      filtered.forEach((task,i)=>{
        let li = document.createElement("li");
        li.className = "list-group-item task-card d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <div>
            <input type="checkbox" ${task.completed?"checked":""} onchange="toggleComplete(${i})"> 
            <span class="${task.completed?"completed":""}">${task.text}</span>
            ${task.deadline?`<small class="text-muted"> ⏰ ${task.deadline}</small>`:""}
            <span class="badge badge-${task.priority=="high"?"danger":task.priority=="medium"?"warning":"success"}">${task.priority}</span>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-success" onclick="addSubtask(${i})">➕ Subtask</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${i})">🗑</button>
          </div>`;
        taskList.appendChild(li);
        
        if (task.subtasks.length){
          let subUl = document.createElement("ul");
          task.subtasks.forEach((s,si)=>{
            let subLi = document.createElement("li");
            subLi.innerHTML = `<input type='checkbox' ${s.completed?"checked":""} onchange="toggleSubtask(${i},${si})"> <span class='${s.completed?"completed":""}'>${s.text}</span>`;
            subUl.appendChild(subLi);
          });
          taskList.appendChild(subUl);
        }
      });
      updateProgress();
    }

    // Toggle complete
    function toggleComplete(i){
      tasks[i].completed = !tasks[i].completed;
      if(tasks[i].completed){ xp+=10; streak++; notify(tasks[i].text); }
      saveTasks();
      renderTasks(document.getElementById("searchInput").value.toLowerCase());
    }

    // Subtasks
    function addSubtask(i){
      let sub = prompt("Enter subtask:");
      if(!sub) return;
      tasks[i].subtasks.push({text:sub, completed:false});
      saveTasks();
      renderTasks();
    }
    function toggleSubtask(i,si){
      tasks[i].subtasks[si].completed=!tasks[i].subtasks[si].completed;
      saveTasks(); renderTasks();
    }

    // Delete
    function deleteTask(i){ tasks.splice(i,1); saveTasks(); renderTasks(); }

    // Update Progress
    function updateProgress(){
      let total=tasks.length;
      let done=tasks.filter(t=>t.completed).length;
      let percent= total? Math.round(done/total*100):0;
      progressBar.style.width=percent+"%";
      progressText.innerText = `Completed ${done}/${total} tasks (${percent}%)`;
      document.getElementById("xp").innerText = xp;
      document.getElementById("streak").innerText = streak;
    }

    // Search
    document.getElementById("searchInput").oninput = e => renderTasks(e.target.value.toLowerCase());

    // Dark mode
    document.getElementById("toggleMode").onclick = ()=> document.body.classList.toggle("dark-mode");

    // Export
    document.getElementById("exportBtn").onclick = ()=>{
      let blob = new Blob([JSON.stringify(tasks)], {type:"application/json"});
      let a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="tasks.json";
      a.click();
    };

    // Import
    document.getElementById("importBtn").onclick = ()=> document.getElementById("importFile").click();
    document.getElementById("importFile").onchange = e=>{
      let reader=new FileReader();
      reader.onload = ()=>{ tasks=JSON.parse(reader.result); saveTasks(); renderTasks(); };
      reader.readAsText(e.target.files[0]);
    };

    // Voice input
    document.getElementById("voiceBtn").onclick = ()=>{
      let rec = new webkitSpeechRecognition();
      rec.onresult = e=>{ taskInput.value = e.results[0][0].transcript; };
      rec.start();
    };

    // Notifications
    function notify(msg){
      if(Notification.permission!=="granted") Notification.requestPermission();
      else new Notification("✅ Task Completed", {body:msg});
    }

    // Drag & Drop
    new Sortable(taskList, { animation:150, onEnd:()=>{ saveTasks(); } });

    renderTasks();
  </script>
</body>
</html>
